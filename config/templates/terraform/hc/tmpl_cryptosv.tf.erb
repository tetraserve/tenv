################ Cryptosv

######## Instance

resource "hcloud_server" "cryptosv-<%= @config['mode'] %>" {
  name = "cryptosv-<%= @config['mode'] %>"
  image = var.image
  server_type = "<%= @config['hc']['cryptosv_machine_type'] %>"
  #location = var.region
  datacenter = var.zone
  ssh_keys = ["${data.hcloud_ssh_key.opendax.id}"]
  <%= RendererHelperHc::provisioner_remote_exec(
    'root', RendererHelperHc::root_user_init("cryptosv-#{@config['mode']}-hc")
  ) %>
  <%= RendererHelperHc::provisioner_file(
    'deploy', 'var.ssh_private_key', '"/home/deploy/.ssh/id_rsa"'
  ) %>
  <%= RendererHelperHc::provisioner_remote_exec(
    'deploy', RendererHelperHc::deploy_user_init
  ) %>
  <%= RendererHelperHc::provisioner_local_exec(
    '"rm -rf /tmp/upload && mkdir -p /tmp/upload && rsync -rv --copy-links --safe-links ../../../ /tmp/upload/"'
  ) %>
  <%= RendererHelperHc::provisioner_file(
    'deploy', '"/tmp/upload/"', '"/home/deploy/opendax"'
  ) %>
  <%= RendererHelperHc::provisioner_remote_exec(
    'deploy', 'script = "../../../bin/install_cryptosv.sh"'
  ) %>
  <%= RendererHelperHc::provisioner_remote_exec(
    'deploy', 'script = "../../../bin/start_cryptosv.sh"'
  ) %>

}

######## Network

resource "hcloud_server_network" "cryptosv-network-<%= @config['mode'] %>" {
  server_id = hcloud_server.cryptosv-<%= @config['mode'] %>.id
  network_id = data.terraform_remote_state.network.outputs.opendax_network.id
  ip = "<%= @config['hc']['cryptosv_machine_ip'] %>"
}

######## Volume

resource "hcloud_volume_attachment" "cryptosv-va1-<%= @config['mode'] %>" {
  volume_id = data.terraform_remote_state.network.outputs.cryptosv-vol1-base.id
  server_id = hcloud_server.cryptosv-<%= @config['mode'] %>.id
  automount = true
}

######## Cloudflare

#### Internal

<%= RendererHelperHc::cloudflare_internal(
    "cryptosv-#{@config['mode']}-internal-hc",
    "cryptosv-#{@config['mode']}.internal.hc",
    "#{@config['hc']['cryptosv_machine_ip']}") %>

#### External

<%= RendererHelperHc::cloudflare_external(
    "cryptosv-#{@config['mode']}-hc",
    "cryptosv-#{@config['mode']}.hc",
    "cryptosv-#{@config['mode']}") %>
