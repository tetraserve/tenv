################ Logsv

######## Instance

resource "hcloud_server" "logsv-<%= @config['mode'] %>" {
  name = "logsv-<%= @config['mode'] %>"
  image = var.image
  server_type = "<%= @config['hc']['logsv_machine_type'] %>"
  #location = var.region
  datacenter = var.zone
  ssh_keys = ["${data.hcloud_ssh_key.opendax.id}"]
  <%= RendererHelperHc::provisioner_remote_exec(
    'root', RendererHelperHc::root_user_init("logsv-#{@config['mode']}-hc")
  ) %>
  <%= RendererHelperHc::provisioner_file(
    'deploy', 'var.ssh_private_key', '"/home/deploy/.ssh/id_rsa"'
  ) %>
  <%= RendererHelperHc::provisioner_remote_exec(
    'deploy', RendererHelperHc::deploy_user_init
  ) %>
  <%= RendererHelperHc::provisioner_local_exec(
    '"rm -rf /tmp/upload && mkdir -p /tmp/upload && rsync -rv --copy-links --safe-links ../../../ /tmp/upload/"'
  ) %>
  <%= RendererHelperHc::provisioner_file(
    'deploy', '"/tmp/upload/"', '"/home/deploy/opendax"'
  ) %>
  <%= RendererHelperHc::provisioner_remote_exec(
    'deploy', 'script = "../../../bin/install_logsv.sh"'
  ) %>
  <%= RendererHelperHc::provisioner_remote_exec(
    'deploy', 'script = "../../../bin/start_logsv.sh"'
  ) %>

}

######## Network

resource "hcloud_server_network" "logsv-network-<%= @config['mode'] %>" {
  server_id = hcloud_server.logsv-<%= @config['mode'] %>.id
  network_id = data.terraform_remote_state.network.outputs.opendax_network.id
  ip = "<%= @config['hc']['logsv_machine_ip'] %>"
}

######## Cloudflare

#### Internal

<%= RendererHelperHc::cloudflare_internal(
    "logsv-#{@config['mode']}-internal-hc",
    "logsv-#{@config['mode']}.internal.hc",
    "#{@config['hc']['logsv_machine_ip']}") %>

#### External

<%= RendererHelperHc::cloudflare_external(
    "logsv-#{@config['mode']}-hc",
    "logsv-#{@config['mode']}.hc",
    "logsv-#{@config['mode']}") %>
